<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #141e30, #243b55);
    height: 100vh;
    overflow: hidden;
    color: white;
}

.container {
    display: flex;
    height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 260px;
    padding: 20px;
    backdrop-filter: blur(20px);
    background: rgba(255,255,255,0.08);
    border-right: 1px solid rgba(255,255,255,0.2);
}

.sidebar h2 {
    text-align: center;
    margin-bottom: 40px;
}

.sidebar button {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    background: rgba(255,255,255,0.15);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: 0.3s;
}

.sidebar button:hover {
    background: rgba(255,255,255,0.3);
}

/* Main */
.main {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
}

/* Header */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logout-btn {
    padding: 10px 20px;
    background: #ff4b5c;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
}

/* Glass Card */
.card {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(15px);
    padding: 20px;
    margin-top: 20px;
    border-radius: 12px;
    transition: 0.3s;
}

.card:hover {
    transform: translateY(-5px);
}

.stats {
    display: flex;
    gap: 20px;
}

.stat-box {
    flex: 1;
    padding: 20px;
    text-align: center;
    border-radius: 12px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(15px);
}

table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
}

th, td {
    padding: 12px;
    text-align: left;
}

th {
    background: rgba(255,255,255,0.2);
}

tr:hover {
    background: rgba(255,255,255,0.1);
}

.delete-btn {
    background: #ff4b5c;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    color: white;
    cursor: pointer;
}

.search-box {
    margin-top: 15px;
    padding: 10px;
    width: 300px;
    border-radius: 6px;
    border: none;
}

</style>
</head>

<body>

<div class="container">

    <div class="sidebar">
        <h2>Admin Panel</h2>
        <button onclick="loadDashboard()">Dashboard</button>
        <button onclick="loadStudents()">Manage Students</button>
        <button onclick="loadFaculty()">Manage Faculty</button>
        <button onclick="loadCreateQuiz()">üß™ Create Quiz</button>
        <button onclick="loadQuizAttempts()">üìä Quiz Attempts</button>
        <button onclick="logout()">Logout</button>
    </div>

    <div class="main">
        <div class="header">
            <h1>Welcome Admin</h1>
        </div>

        <div id="content"></div>
    </div>

</div>

<script>

function logout(){
    localStorage.clear();
    window.location.href = "admin-login.html";
}

/* Dashboard Stats */
async function loadDashboard(){
    const studentRes = await fetch("http://localhost:5000/admin/students");
    const students = await studentRes.json();

    const facultyRes = await fetch("http://localhost:5000/admin/faculty");
    const faculty = await facultyRes.json();

    document.getElementById("content").innerHTML = `
        <div class="stats">
            <div class="stat-box">
                <h2>${students.length}</h2>
                <p>Total Students</p>
            </div>
            <div class="stat-box">
                <h2>${faculty.length}</h2>
                <p>Total Faculty</p>
            </div>
        </div>
    `;
}

/* Load Students */
async function loadStudents(){
    const res = await fetch("http://localhost:5000/admin/students");
    const students = await res.json();

    let html = `
        <h2>Manage Students</h2>

        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; margin-bottom: 18px;">
            <h3 style="margin: 0 0 8px 0;">‚ûï Add Student</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <input id="newStudentName" placeholder="Full name">
                <input id="newStudentEmail" placeholder="Email">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: center;">
                <input id="newStudentDept" placeholder="Department">
                <input id="newStudentPassword" placeholder="Password" type="password">
            </div>
            <div style="margin-top: 10px; text-align: right;">
                <button class="btn btn-primary" onclick="createStudent()">Add Student</button>
            </div>
            <div id="addStudentMsg" style="margin-top:8px"></div>
        </div>

        <input class="search-box" placeholder="Search by email..." onkeyup="filterTable(this)">
        <table>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Department</th>
            <th>Action</th>
        </tr>
    `;

    students.forEach(s=>{
        html += `
            <tr>
                <td>${s.name}</td>
                <td>${s.email}</td>
                <td>${s.department || ''}</td>
                <td>
                    <button class="delete-btn" onclick="deleteStudent('${s._id}')">Delete</button>
                </td>
            </tr>
        `;
    });

    html += "</table>";
    document.getElementById("content").innerHTML = html;
}

/* Create Student (from Admin) */
async function createStudent(){
    const name = document.getElementById('newStudentName').value.trim();
    const email = document.getElementById('newStudentEmail').value.trim();
    const department = document.getElementById('newStudentDept').value.trim();
    const password = document.getElementById('newStudentPassword').value;
    const msgDiv = document.getElementById('addStudentMsg');

    msgDiv.textContent = '';

    if(!name || !email || !department || !password){
        msgDiv.style.color = '#ff6b6b';
        msgDiv.textContent = 'Please fill all fields';
        return;
    }

    try{
        const res = await fetch('http://localhost:5000/admin/add-student', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, department, password })
        });

        const data = await res.json();
        if(res.ok){
            msgDiv.style.color = '#4caf50';
            msgDiv.textContent = 'Student added successfully';
            // Clear inputs
            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentEmail').value = '';
            document.getElementById('newStudentDept').value = '';
            document.getElementById('newStudentPassword').value = '';
            // Refresh list
            setTimeout(loadStudents, 800);
        } else {
            msgDiv.style.color = '#ff6b6b';
            msgDiv.textContent = data.message || 'Error adding student';
        }
    } catch(err){
        console.error('Add student error:', err);
        msgDiv.style.color = '#ff6b6b';
        msgDiv.textContent = 'Error adding student';
    }
}

/* Load Faculty */
async function loadFaculty(){
    const res = await fetch("http://localhost:5000/admin/faculty");
    const faculty = await res.json();

    let html = `
        <h2>Manage Faculty</h2>

        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; margin-bottom: 18px;">
            <h3 style="margin: 0 0 8px 0;">‚ûï Add Faculty</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <input id="newFacultyName" placeholder="Full name">
                <input id="newFacultyEmail" placeholder="Email">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: center;">
                <input id="newFacultyDept" placeholder="Department">
                <input id="newFacultyPassword" placeholder="Password" type="password">
            </div>
            <div style="margin-top: 10px; text-align: right;">
                <button class="btn btn-primary" onclick="createFaculty()">Add Faculty</button>
            </div>
            <div id="addFacultyMsg" style="margin-top:8px"></div>
        </div>

        <table>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Department</th>
            <th>Action</th>
        </tr>
    `;

    faculty.forEach(f=>{
        html += `
            <tr>
                <td>${f.name}</td>
                <td>${f.email}</td>
                <td>${f.department || ''}</td>
                <td>
                    <button class="delete-btn" onclick="deleteFaculty('${f._id}')">Delete</button>
                </td>
            </tr>
        `;
    });

    html += "</table>";
    document.getElementById("content").innerHTML = html;
}

/* Create Faculty (from Admin) */
async function createFaculty(){
    const name = document.getElementById('newFacultyName').value.trim();
    const email = document.getElementById('newFacultyEmail').value.trim();
    const department = document.getElementById('newFacultyDept').value.trim();
    const password = document.getElementById('newFacultyPassword').value;
    const msgDiv = document.getElementById('addFacultyMsg');

    msgDiv.textContent = '';

    if(!name || !email || !department || !password){
        msgDiv.style.color = '#ff6b6b';
        msgDiv.textContent = 'Please fill all fields';
        return;
    }

    try{
        const res = await fetch('http://localhost:5000/admin/add-faculty', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, department, password })
        });

        const data = await res.json();
        if(res.ok){
            msgDiv.style.color = '#4caf50';
            msgDiv.textContent = 'Faculty added successfully';
            // Clear inputs
            document.getElementById('newFacultyName').value = '';
            document.getElementById('newFacultyEmail').value = '';
            document.getElementById('newFacultyDept').value = '';
            document.getElementById('newFacultyPassword').value = '';
            // Refresh list
            setTimeout(loadFaculty, 800);
        } else {
            msgDiv.style.color = '#ff6b6b';
            msgDiv.textContent = data.message || 'Error adding faculty';
        }
    } catch(err){
        console.error('Add faculty error:', err);
        msgDiv.style.color = '#ff6b6b';
        msgDiv.textContent = 'Error adding faculty';
    }
}

async function deleteStudent(id){
    await fetch(`http://localhost:5000/admin/student/${id}`,{
        method:"DELETE"
    });
    loadStudents();
}

async function deleteFaculty(id){
    await fetch(`http://localhost:5000/admin/faculty/${id}`,{
        method:"DELETE"
    });
    loadFaculty();
}

/* Search Filter */
function filterTable(input){
    const filter = input.value.toLowerCase();
    const rows = document.querySelectorAll("table tr");

    rows.forEach((row, index)=>{
        if(index === 0) return;
        const email = row.children[1].innerText.toLowerCase();
        row.style.display = email.includes(filter) ? "" : "none";
    });
}

/* ===== QUIZ CREATION ===== */
let questionsArray = [];

function loadCreateQuiz() {
    let html = `
        <div class="quiz-creation">
            <h2>üß™ Create New Quiz</h2>
            
            <div class="form-group">
                <label>Quiz Title:</label>
                <input type="text" id="quizTitle" placeholder="Enter quiz title">
            </div>

            <div class="form-group">
                <label>Quiz Description:</label>
                <textarea id="quizDescription" placeholder="Enter quiz description"></textarea>
            </div>

            <div class="form-group">
                <label>Time Limit (minutes):</label>
                <input type="number" id="timeLimit" placeholder="e.g., 30" min="1">
            </div>

            <hr style="margin: 20px 0; opacity: 0.3;">

            <h3>üìã Questions</h3>
            <div id="questionsContainer"></div>

            <button style="background: #4CAF50; padding: 10px 20px; border: none; border-radius: 6px; color: white; cursor: pointer; margin-top: 15px;" onclick="addQuestion()">+ Add Question</button>

            <div style="margin-top: 30px; display: flex; gap: 10px;">
                <button style="background: #2196F3; padding: 12px 30px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 16px;" onclick="createQuiz()">‚úÖ Create Quiz</button>
                <button style="background: #666; padding: 12px 30px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 16px;" onclick="loadDashboard()">Cancel</button>
            </div>

            <div id="quizMessage" style="margin-top: 15px;"></div>
        </div>

        <style>
            .quiz-creation {
                background: rgba(255,255,255,0.08);
                padding: 30px;
                border-radius: 12px;
                backdrop-filter: blur(15px);
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: bold;
            }

            .form-group input,
            .form-group textarea {
                width: 100%;
                padding: 10px;
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 6px;
                background: rgba(255,255,255,0.1);
                color: white;
                font-size: 14px;
                box-sizing: border-box;
            }

            .form-group textarea {
                resize: vertical;
                min-height: 80px;
            }

            .form-group input::placeholder,
            .form-group textarea::placeholder {
                color: rgba(255,255,255,0.6);
            }

            .question-block {
                background: rgba(255,255,255,0.06);
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                border: 1px solid rgba(255,255,255,0.1);
            }

            .question-block h4 {
                margin-top: 0;
                color: #4CAF50;
            }

            .question-block input,
            .question-block textarea {
                width: 100%;
                padding: 8px;
                margin-bottom: 10px;
                border: 1px solid rgba(255,255,255,0.2);
                border-radius: 4px;
                background: rgba(255,255,255,0.08);
                color: white;
                font-size: 13px;
                box-sizing: border-box;
            }

            .options-container {
                background: rgba(255,255,255,0.04);
                padding: 15px;
                border-radius: 6px;
                margin: 10px 0;
            }

            .option-input {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
                align-items: center;
            }

            .option-input input {
                flex: 1;
                margin: 0;
            }

            .option-input input[type="radio"] {
                width: 20px;
                flex: 0;
            }

            .remove-option-btn {
                background: #ff4b5c;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            }

            .remove-question-btn {
                background: #ff4b5c;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 10px;
            }

            .add-option-btn {
                background: #FF9800;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                margin-top: 10px;
            }

            #quizMessage {
                padding: 12px;
                border-radius: 6px;
                font-weight: bold;
                display: none;
            }

            #quizMessage.success {
                background: rgba(76, 175, 80, 0.3);
                color: #4CAF50;
                display: block;
            }

            #quizMessage.error {
                background: rgba(255, 75, 92, 0.3);
                color: #ff4b5c;
                display: block;
            }
        </style>
    `;

    document.getElementById("content").innerHTML = html;
    questionsArray = [];
    addQuestion(); // Add first question by default
}

function addQuestion() {
    const qIndex = questionsArray.length;
    questionsArray.push({
        question: '',
        options: ['', '', '', ''],
        correctAnswer: 0,
        points: 10
    });

    renderQuestions();
}

function removeQuestion(index) {
    questionsArray.splice(index, 1);
    renderQuestions();
}

function addOption(qIndex) {
    questionsArray[qIndex].options.push('');
    renderQuestions();
}

function removeOption(qIndex, optIndex) {
    questionsArray[qIndex].options.splice(optIndex, 1);
    // Update correctAnswer if needed
    if (questionsArray[qIndex].correctAnswer >= questionsArray[qIndex].options.length) {
        questionsArray[qIndex].correctAnswer = 0;
    }
    renderQuestions();
}

function renderQuestions() {
    let html = '';

    questionsArray.forEach((q, qIndex) => {
        html += `
            <div class="question-block">
                <h4>Question ${qIndex + 1}</h4>
                
                <label>Question Text:</label>
                <textarea placeholder="Enter question" onchange="questionsArray[${qIndex}].question = this.value">${q.question}</textarea>

                <label>Points for this question:</label>
                <input type="number" value="${q.points}" min="1" onchange="questionsArray[${qIndex}].points = parseInt(this.value)" style="width: 100px;">

                <h5 style="margin-top: 15px;">Answer Options:</h5>
                <div class="options-container">
        `;

        q.options.forEach((opt, optIndex) => {
            html += `
                <div class="option-input">
                    <input type="radio" name="correct_${qIndex}" value="${optIndex}" ${q.correctAnswer === optIndex ? 'checked' : ''} onchange="questionsArray[${qIndex}].correctAnswer = ${optIndex}">
                    <input type="text" placeholder="Option ${optIndex + 1}" value="${opt}" onchange="questionsArray[${qIndex}].options[${optIndex}] = this.value">
                    <button class="remove-option-btn" onclick="removeOption(${qIndex}, ${optIndex})">Remove</button>
                </div>
            `;
        });

        html += `
                </div>
                <button class="add-option-btn" onclick="addOption(${qIndex})">+ Add Option</button>
                <button class="remove-question-btn" onclick="removeQuestion(${qIndex})">üóëÔ∏è Remove Question</button>
            </div>
        `;
    });

    document.getElementById('questionsContainer').innerHTML = html;
}

async function createQuiz() {
    const title = document.getElementById('quizTitle').value;
    const description = document.getElementById('quizDescription').value;
    const timeLimit = parseInt(document.getElementById('timeLimit').value);
    const msgDiv = document.getElementById('quizMessage');

    if (!title || !description || !timeLimit) {
        msgDiv.className = 'error';
        msgDiv.textContent = '‚ùå Please fill all fields';
        return;
    }

    if (questionsArray.length === 0) {
        msgDiv.className = 'error';
        msgDiv.textContent = '‚ùå Please add at least one question';
        return;
    }

    // Validate all questions have options and correct answer
    for (let q of questionsArray) {
        if (!q.question) {
            msgDiv.className = 'error';
            msgDiv.textContent = '‚ùå All questions must have text';
            return;
        }
        if (q.options.some(opt => !opt)) {
            msgDiv.className = 'error';
            msgDiv.textContent = '‚ùå All options must have text';
            return;
        }
        if (q.points <= 0) {
            msgDiv.className = 'error';
            msgDiv.textContent = '‚ùå All questions must have points > 0';
            return;
        }
    }

    try {
        const res = await fetch('http://localhost:5000/admin/create-quiz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title,
                description,
                timeLimit,
                questions: questionsArray,
                createdBy: localStorage.getItem('adminEmail') || 'admin'
            })
        });

        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();

        if (data.success) {
            msgDiv.className = 'success';
            msgDiv.textContent = '‚úÖ Quiz created successfully!';
            setTimeout(() => {
                loadDashboard();
            }, 1500);
        } else {
            msgDiv.className = 'error';
            msgDiv.textContent = '‚ùå Error: ' + data.message;
        }
    } catch (error) {
        msgDiv.className = 'error';
        msgDiv.textContent = '‚ùå Error: ' + error.message;
    }
}

/* Load Quiz Attempts */
async function loadQuizAttempts(){
    const res = await fetch("http://localhost:5000/admin/all-quiz-attempts");
    const data = await res.json();
    
    const attempts = data.attempts || [];
    
    let html = `
        <h2>üìä Student Quiz Attempts</h2>
        <table style="width: 100%; border-collapse: collapse; text-align: left; margin-top: 20px;">
            <tr style="background: #667eea; color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Student Name</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Email</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Quiz</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Score</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Percentage</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Date</th>
            </tr>
    `;
    
    if (attempts.length === 0) {
        html += `<tr><td colspan="6" style="padding: 20px; text-align: center;">No quiz attempts yet</td></tr>`;
    } else {
        attempts.forEach(attempt => {
            const quizTitle = attempt.quizId?.title || 'N/A';
            const studentName = attempt.studentId?.name || 'Unknown';
            const studentEmail = attempt.studentId?.email || 'N/A';
            const date = new Date(attempt.createdAt).toLocaleDateString();
            const percentage = Math.round(attempt.percentage || 0);
            const statusColor = percentage >= 50 ? '#4caf50' : '#f44336';
            
            html += `
                <tr style="border: 1px solid #ddd;">
                    <td style="padding: 12px; border: 1px solid #ddd;">${studentName}</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${studentEmail}</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${quizTitle}</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${attempt.totalScore}</td>
                    <td style="padding: 12px; border: 1px solid #ddd; color: ${statusColor}; font-weight: bold;">${percentage}%</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${date}</td>
                </tr>
            `;
        });
    }
    
    html += '</table>';
    document.getElementById("content").innerHTML = html;
}

loadDashboard();

</script>

</body>
</html>
